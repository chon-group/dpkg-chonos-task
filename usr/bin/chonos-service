#!/bin/sh
MAX_TRIES=3
SLEEP_BETWEEN=2

while getopts s:t:w:-: flag 
    do
    case "${flag}" in
        s) SERVICE=${OPTARG};;  
        t) MAX_TRIES=${OPTARG};;  
        w) SLEEP_BETWEEN=${OPTARG};;  
        -) ACTION=${OPTARG};;
    esac
done

tryStartService() {
    i=1
    while [ "$i" -le "$MAX_TRIES" ]; do
        chonos-log -e "[chonos-task] [$i/$MAX_TRIES] Starting $SERVICE..."

        if systemctl start "$SERVICE"; then
            sleep "$SLEEP_BETWEEN"
            if systemctl is-active --quiet "$SERVICE"; then
                chonos-log -e "[chonos-task] Service $SERVICE is active."
                return 0
            fi
        fi

        chonos-log -e "[chonos-task] Failed to start $SERVICE."
        i=$(expr $i + 1)

        if [ "$i" -le "$MAX_TRIES" ]; then
            chonos-log -e "[chonos-task] Retrying in $SLEEP_BETWEEN seconds..."
            sleep "$SLEEP_BETWEEN"
        fi
    done

    chonos-log -e "[chonos-task] FAILURE: could not start $SERVICE after $MAX_TRIES attempts."
    return 1
}

### -------------------------
### ACTION HANDLING
### -------------------------

case "$ACTION" in

    start)
        tryStartService "$SERVICE"
        exit $?
    ;;

    stop)
        systemctl stop "$SERVICE"
        exit $?
    ;;

    restart)
        systemctl stop "$SERVICE"
        sleep "$SLEEP_BETWEEN"
        tryStartService "$SERVICE"
        exit $?
    ;;

    *)
        echo "Unknown action: $ACTION"
        echo "Available: --start, --stop, --restart"
        exit 1
    ;;
esac
